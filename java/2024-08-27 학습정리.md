# DataBase

## MultiValue 제거

- 멀티벨류를 제거할때 pk가 중복되는 것도 제거한다.

중복되는 것들을 별도의 테이블로 분리하여 FK로 받아 올 수 있도록한다.

적어도 10개 이상은 검증해봐야 멀티벨류가 생기는지 알 수 있다.

- 그 후 테이블 명세서를 만든다.
- 설명과 참조테이블 등을 만든다.
- 그것들을 기반으로 ER-D를 만들고 포워드 엔지니어링을 하여 테이블을 만든다.
- FK값을 지정해주지 않으며 INDEX로 지정해준다.

**FK값을 지정해 주지 않는 이유**

FK 의 값을 지우고 싶을때 참조하는 데이터들을 전부 삭제해한다. 그럴때 참조하고 있는 데이터들의 문제가 발생한다.

따라서 FK를 지정하지 않고 원하는 값을 빠르게 찾을 수 있도록 INDEX를 지정해준다.

또한 FK는 데이터 삭제 혹은 수정할때 방해하기 때문에 실무에서 작성하지 않는다.

## KEY TABLE

ER-D를 작성하면 KEY TABLE이 몇개인지 보인다.

KEY TABLE은 관계를 가장 많이 주는 테이블이다.

모든 SQL은 KEY TABLE로 시작한다.

## INSERT

ROW를 추가하는 것이 INSERT이다.

INSERT INTO , VALUES를 사용하여 값을 추가한다.

예제)
```SQL
INSERT INTO TABLE ( COLUMN, COLUMN)
VALUES (VALUE, VALUE)
;
```
**NULL을 지원하는 컬럼은 생략 가능하지만 작성중 바뀔 수도 있기 때문에 웬만하면 다 작성해준다.**

## 데이터베이스 취약점

### 동시성 문제

한가지 일에 여러명이 동시에 일을 한다고 가정해보자.

한가지 일에 여러명이 동시에 INSERT를 진행중인데 같은 번호로 INSERT를 한다면 제일 빨리 등록한 사람을 제외하고 등록이 되지 않는 동시성 문제가 발생한다. 

그렇다면 데이터베이스에 등록되어있는 데이터 번호에서 +1을 하여 등록한다면 문제가 발생하지 않을것같다. 하지만 역시 동시성 문제가 발생한다.

여러명이 데이터번호에+1을 사용하여 INSERT를 하려고 한다면 동시에 +1이 되기때문에 그 데이터번호의 기준은 같아서 제일 빨리 등록한 사람을 제외하고 등록되지 않는 동시성 문제가 발생한다.

따라서, 데이터베이스에서 미리 번호를 발급해놓고 받아가는 시퀀스를 사용해야한다.

## **Sequence**

동시성문제를 해결하는 쿼리이다.

데이터베이스에서 번호를 미리 발급받아놓고 하나씩 번호를 준다.

주로 PK를 만들때 사용된다.

PK의 수만큼 시퀀스가 있다.

모든 시퀀스는 사이클을 돌게 만든다. VARCHAR2(20 CHAR)

여기서 20 CHAR는 MAXVALUE 숫자가 6자리이다.(999999)

시퀀스 이름

예제)
```
MV_INFO_PK_SEQ
```
테이블명_PK_SEQ로 짓기로 약속한다.

예제)
```SQL
SELECT MV_INFO_PK_SEQ.NEXTVAL
  FROM DUAL
;
```
NEXTVAL을 사용하여 다음번호를 부여한다.

**시퀀스 사용시 주의점**

시퀀스의 값은 중복이 될 수 있기 때문에 뒤로 다시 돌아올 수 없다.

그렇기 때문에 다시 돌리고 싶다면 시퀀스를 삭제하고 다시 만들어야한다.

![image](https://github.com/user-attachments/assets/a12a8019-a95f-402c-a6a9-efdb4c607651)


Sequence Name : 시퀀스 이름

Value : 시작기준 값

Min Value : 최소 값 

Max Value : 최대 값

Increment : 증가 값

Cache : 데이터베이스가 미리 만들어 둘 값.

Cycle : 체크시, 최대 값에 도달했을 시 Cycle로 다시 처음 값으로 되돌아감

이때, 중복이 될 수 있으므로 앞에 접두사 - 연월일(시) - 번호로 구성된다. 총 18자리이다. 

연월일이 또 중복될 수 있으므로 시까지 작성할 수 있게 20자리로 여유를 둔다.

접두사 : 어디 PK인지 알려주기 위해 두자리 정도로 알려준다.

VARCHAR2(20 CHAR) 은 MAX VALUE 값이 6자리이다. ( 999999 )

정렬 예제)

왼쪽으로 정렬하고 글자수가 비어있는 만큼 0을 추가한다.
```SQL
SELECT LPAD(DRCTR_INFO_PK_SEQ.NEXTVAL, 5, '0') -- 00002
  FROM DUAL
;
```
접두어-년월일-시퀀스 (CONCAT) 예제)
```SQL
SELECT 'MA-' || TO_CHAR(SYSDATE, 'YYYYMMDD') || '-' || LPAD(MV_ACTR_PK_SEQ.NEXTVAL, 6, '0')
  FROM DUAL
;
```
